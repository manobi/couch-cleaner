#!/usr/bin/env node
var url = require("url");
var path = require("path");
var CouchCleaner = require("../couch-cleaner");
var program = require('commander');

program
  .version('0.0.3')
  .option('-a, --all', 'clear all docs')
  .option('-f, --filter [docs]', 'filter some docs from cleanup')
  .option('-l, --login [user]', 'pass username to auth')
  .parse(process.argv);

var database = process.ARGV[2];
var options = {};
if(database){
	options = url.parse(database);
	options.db = options.pathname.replace("/","");
	
	if(options.hostname){ options.host = options.hostname;}
	else {options.host = "localhost";}
	
	if(!options.port){ options.port = 5984;}
	if(!options.procotocol){options.procotocol = "http";}
	
	if(options.auth){
		var auth = options.auth.split(":");
		options.login = auth[0];
		options.password = auth[1];
	}
}


if(program.login){
	options.auth = true;
	options.login = program.login;
	program.password('Password:',function(key){
		options.password = key;
		process.stdin.destroy();
		ready();
	});
}

function ready(){
	var cleaner = new CouchCleaner(options);
	if(program.filter){
		var docs = program.filter.split(',');
		cleaner.filter(docs);
	}
	cleaner.clear();
}

/**
** couch-cleaner database --all
** couch-cleaner database --filter vader leia skate
**/